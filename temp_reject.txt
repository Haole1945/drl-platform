
  import { Button } from '@/components/ui/button';
  import { Textarea } from '@/components/ui/textarea';
  import { Input } from '@/components/ui/input';
  import { Label } from '@/components/ui/label';
  import { useToast } from '@/hooks/use-toast';
> import { getEvaluationById, submitEvaluation, approveEvaluation, rejectEvaluation, 
getActiveRubric, getCriteriaByRubric, deleteEvaluation } from '@/lib/evaluation';
  import { StatusBadge } from '@/components/StatusBadge';
  import { EvaluationHistory } from '@/components/EvaluationHistory';
  import { canApproveClassLevel, canApproveAdvisorLevel, canApproveFacultyLevel } from 
'@/lib/role-utils';
  import type { Evaluation, Rubric, Criteria, CriteriaWithSubCriteria,SubCriteria } from 
'@/types/evaluation';
  import { Badge } from '@/components/ui/badge';
    const [evaluation, setEvaluation] = useState<Evaluation | null>(null);
    const [rubric, setRubric] = useState<Rubric | null>(null);
    const [criteria, setCriteria] = useState<Criteria[]>([]);
    const [loading, setLoading] = useState(true);
    const [submitting, setSubmitting] = useState(false);
>   const [rejectionReason, setRejectionReason] = useState('');
    const [approvalComment, setApprovalComment] = useState('');
    const [approvalScores, setApprovalScores] = useState<Record<number, number>>({}); // 
criteriaId -> score
    const [classMonitorSubCriteriaScores, setClassMonitorSubCriteriaScores] = 
useState<Record<string, number>>({}); // "criterionId_subCriteriaId" -> score (for class 
monitor)
    const [advisorSubCriteriaScores, setAdvisorSubCriteriaScores] = useState<Record<string, 
number>>({}); // "criterionId_subCriteriaId" -> score (for advisor)
>   const [showRejectDialog, setShowRejectDialog] = useState(false);
    const [showApproveDialog, setShowApproveDialog] = useState(false);
    const [showDeleteDialog, setShowDeleteDialog] = useState(false);
    const [openPeriod, setOpenPeriod] = useState<any>(null);
    const [canEditInPeriod, setCanEditInPeriod] = useState(false);
    const [criteriaFiles, setCriteriaFiles] = useState<Record<number, number[]>>({}); // 
criteriaId -> fileIds[]
        setSubmitting(false);
        setShowDeleteDialog(false);
      }
    };
  
>   const handleReject = async () => {
>     if (!evaluationId || !rejectionReason.trim()) {
        toast({
          title: "Lá»—i",
          description: "Vui lÃ²ng nháº­p lÃ½ do tá»« chá»‘i.",
          variant: "destructive"
        });
        return;
      }
  
      setSubmitting(true);
      try {
>       const response = await rejectEvaluation(evaluationId, rejectionReason);
        if (response.success) {
          toast({
            title: "ThÃ nh cÃ´ng",
            description: "ÄÃ¡nh giÃ¡ Ä‘Ã£ bá»‹ tá»« chá»‘i.",
          });
          setEvaluation(response.data);
>         setShowRejectDialog(false);
>         setRejectionReason('');
        }
      } catch (error: any) {
        toast({
          title: "Lá»—i",
          description: error.message || "KhÃ´ng thá»ƒ tá»« chá»‘i Ä‘Ã¡nh giÃ¡.",
    const canDelete = isOwner && evaluation.status === 'DRAFT';
    
    // Only owner can edit their own evaluation
    const canEdit = isOwner && (
      evaluation.status === 'DRAFT' || 
>     evaluation.status === 'REJECTED' ||
      (canEditInPeriod && (evaluation.status === 'SUBMITTED' || evaluation.status === 
'CLASS_APPROVED' || evaluation.status === 'FACULTY_APPROVED'))
    );
  
    return (
      <ProtectedRoute>
                <StatusBadge status={evaluation.status} />
                <div className="flex items-center gap-2">
                  {canEdit && (
                    <Button variant="outline" size="sm" onClick={() => 
router.push(`/evaluations/${evaluation.id}/edit`)}>
                      <Edit className="mr-2 h-4 w-4" />
>                     {evaluation.status === 'REJECTED' ? 'Chá»‰nh sá»a & Ná»™p láº¡i' : 
'Chá»‰nh sá»a'}
                    </Button>
                  )}
                  {evaluation.status === 'FACULTY_APPROVED' && isOwner && (
                    <AppealButton
                      evaluationId={evaluation.id}
                        </Button>
                      </DialogFooter>
                    </DialogContent>
                  </Dialog>
  
>                 <Dialog open={showRejectDialog} onOpenChange={setShowRejectDialog}>
                    <DialogTrigger asChild>
                      <Button variant="destructive">
                        <X className="mr-2 h-4 w-4" />
                        Tá»« chá»‘i
                      </Button>
                          Vui lÃ²ng nháº­p lÃ½ do tá»« chá»‘i
                        </DialogDescription>
                      </DialogHeader>
                      <div className="space-y-4">
                        <div>
>                         <Label htmlFor="rejection-reason">LÃ½ do tá»« chá»‘i *</Label>
                          <Textarea
>                           id="rejection-reason"
                            placeholder="Nháº­p lÃ½ do tá»« chá»‘i..."
>                           value={rejectionReason}
>                           onChange={(e) => setRejectionReason(e.target.value)}
                            rows={4}
                            required
                          />
                        </div>
                      </div>
                      <DialogFooter>
>                       <Button variant="outline" onClick={() => setShowRejectDialog(false)}>
                          Há»§y
                        </Button>
>                       <Button variant="destructive" onClick={handleReject} 
disabled={submitting || !rejectionReason.trim()}>
                          {submitting ? (
                            <>
                              <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                              Äang tá»« chá»‘i...
                            </>


