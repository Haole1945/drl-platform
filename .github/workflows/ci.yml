name: CI

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main", "develop"]

jobs:
  build-and-lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # ---------- Backend build ----------
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Build gateway (Maven)
        working-directory: ./gateway
        run: mvn -B -q -DskipTests package

      - name: Build student-service (Maven)
        working-directory: ./student-service
        run: mvn -B -q -DskipTests package

      # ---------- Frontend lint + build ----------
      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "frontend/package-lock.json"

      - name: Install frontend deps
        working-directory: ./frontend
        run: npm install

      - name: Lint frontend
        working-directory: ./frontend
        run: npm run lint

      - name: Build frontend
        working-directory: ./frontend
        env:
          NEXT_PUBLIC_API_BASE: "http://gateway:8080"
        run: npm run build

      # ---------- Docker build smoke test ----------
      - name: Build docker images
        run: |
          docker build -t drl-gateway:ci ./gateway
          docker build -t drl-student-service:ci ./student-service
          docker build -t drl-frontend:ci --build-arg NEXT_PUBLIC_API_BASE=http://gateway:8080 ./frontend
